{
 "Resources": {
  "HeadscaleEC2": {
   "Properties": {
    "ImageId": "ami-08116b9957a259459",
    "InstanceType": "t2.micro",
    "SecurityGroupIds": [
     {
      "Ref": "MySecurityGroup"
     }
    ],
    "SubnetId": {
     "Ref": "MySubnet"
    }
   },
   "Type": "AWS::EC2::Instance"
  },
  "HeadscaleEC2Keypair": {
   "Properties": {
    "KeyName": "HeadscaleEC2Keypair"
   },
   "Type": "AWS::EC2::KeyPair"
  },
  "HeadscaleInternetGateway": {
   "Type": "AWS::EC2::InternetGateway"
  },
  "HeadscaleRouteTable": {
   "Properties": {
    "VpcId": {
     "Ref": "HeadscaleVpc"
    }
   },
   "Type": "AWS::EC2::RouteTable"
  },
  "HeadscaleVpc": {
   "Properties": {
    "CidrBlock": "2001:db8::/32",
    "EnableDnsHostnames": true,
    "EnableDnsSupport": true,
    "InstanceTenancy": "default"
   },
   "Type": "AWS::EC2::VPC"
  },
  "HeadscaleVpcGatewayAttachment": {
   "Properties": {
    "InternetGatewayId": {
     "Ref": "HeadscaleInternetGateway"
    },
    "VpcId": {
     "Ref": "HeadscaleVpc"
    }
   },
   "Type": "AWS::EC2::VPCGatewayAttachment"
  },
  "KeyPairValue": {
   "Properties": {
    "Name": "/headscale/ec2keypair",
    "Type": "SecureString",
    "Value": {
     "Ref": "HeadscaleEC2Keypair"
    }
   },
   "Type": "AWS::SSM::Parameter"
  },
  "MySecurityGroup": {
   "Properties": {
    "GroupDescription": "Allow SSH from specific IPv6 address",
    "VpcId": {
     "Ref": "HeadscaleVpc"
    }
   },
   "Type": "AWS::EC2::SecurityGroup"
  },
  "MySecurityGroupIngress": {
   "Properties": {
    "CidrIpv6": "2001:558:600a:8b:fca3:bb10:9ff5:6b0a/128",
    "FromPort": "22",
    "GroupId": {
     "Ref": "MySecurityGroup"
    },
    "IpProtocol": "tcp",
    "ToPort": "22"
   },
   "Type": "AWS::EC2::SecurityGroupIngress"
  },
  "MySubnet": {
   "Properties": {
    "CidrBlock": "2001:db8::/64",
    "MapPublicIpOnLaunch": true,
    "VpcId": {
     "Ref": "HeadscaleVpc"
    }
   },
   "Type": "AWS::EC2::Subnet"
  },
  "MySubnetRouteTableAssociation": {
   "Properties": {
    "RouteTableId": {
     "Ref": "HeadscaleRouteTable"
    },
    "SubnetId": {
     "Ref": "MySubnet"
    }
   },
   "Type": "AWS::EC2::SubnetRouteTableAssociation"
  },
  "Route": {
   "Properties": {
    "DestinationCidrBlock": "::/0",
    "GatewayId": {
     "Ref": "HeadscaleInternetGateway"
    },
    "RouteTableId": {
     "Ref": "HeadscaleRouteTable"
    }
   },
   "Type": "AWS::EC2::Route"
  }
 }
}